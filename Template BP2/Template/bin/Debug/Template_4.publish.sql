/*
Deployment script for DiplomskiBaza

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "DiplomskiBaza"
:setvar DefaultFilePrefix "DiplomskiBaza"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The type for column Prezime in table [dbo].[Navijac] is currently  VARCHAR (30) NOT NULL but is being changed to  INT NOT NULL. Data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Navijac])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Dropping [dbo].[Stadion_Grad_FK]...';


GO
ALTER TABLE [dbo].[Stadion] DROP CONSTRAINT [Stadion_Grad_FK];


GO
PRINT N'Dropping [dbo].[Tim_Grad_FK]...';


GO
ALTER TABLE [dbo].[Tim] DROP CONSTRAINT [Tim_Grad_FK];


GO
PRINT N'Dropping [dbo].[Igrac_Tim_FK]...';


GO
ALTER TABLE [dbo].[Igrac] DROP CONSTRAINT [Igrac_Tim_FK];


GO
PRINT N'Dropping [dbo].[LicnaNagrada_Igrac_FK]...';


GO
ALTER TABLE [dbo].[LicnaNagrada] DROP CONSTRAINT [LicnaNagrada_Igrac_FK];


GO
PRINT N'Dropping [dbo].[Karta_Odrzava_FK]...';


GO
ALTER TABLE [dbo].[Karta] DROP CONSTRAINT [Karta_Odrzava_FK];


GO
PRINT N'Dropping [dbo].[Kupuje_Karta_FK]...';


GO
ALTER TABLE [dbo].[Kupuje] DROP CONSTRAINT [Kupuje_Karta_FK];


GO
PRINT N'Dropping [dbo].[LicnaNagrada_Nagrada_FK]...';


GO
ALTER TABLE [dbo].[LicnaNagrada] DROP CONSTRAINT [LicnaNagrada_Nagrada_FK];


GO
PRINT N'Dropping [dbo].[TimskaNagrada_Nagrada_FK]...';


GO
ALTER TABLE [dbo].[TimskaNagrada] DROP CONSTRAINT [TimskaNagrada_Nagrada_FK];


GO
PRINT N'Dropping [dbo].[Kupuje_Navijac_FK]...';


GO
ALTER TABLE [dbo].[Kupuje] DROP CONSTRAINT [Kupuje_Navijac_FK];


GO
PRINT N'Dropping [dbo].[Odrzava_Stadion_FK]...';


GO
ALTER TABLE [dbo].[Odrzava] DROP CONSTRAINT [Odrzava_Stadion_FK];


GO
PRINT N'Dropping [dbo].[Igra_Sudija_FK]...';


GO
ALTER TABLE [dbo].[Igra] DROP CONSTRAINT [Igra_Sudija_FK];


GO
PRINT N'Dropping [dbo].[Igra_Tim_FK]...';


GO
ALTER TABLE [dbo].[Igra] DROP CONSTRAINT [Igra_Tim_FK];


GO
PRINT N'Dropping [dbo].[TimskaNagrada_Tim_FK]...';


GO
ALTER TABLE [dbo].[TimskaNagrada] DROP CONSTRAINT [TimskaNagrada_Tim_FK];


GO
PRINT N'Dropping [dbo].[Igra_Utakmica_FK]...';


GO
ALTER TABLE [dbo].[Igra] DROP CONSTRAINT [Igra_Utakmica_FK];


GO
PRINT N'Dropping [dbo].[Odrzava_Utakmica_FK]...';


GO
ALTER TABLE [dbo].[Odrzava] DROP CONSTRAINT [Odrzava_Utakmica_FK];


GO
PRINT N'Dropping unnamed constraint on [dbo].[LicnaNagrada]...';


GO
ALTER TABLE [dbo].[LicnaNagrada] DROP CONSTRAINT [CK__LicnaNagr__Vrsta__5070F446];


GO
PRINT N'Dropping unnamed constraint on [dbo].[TimskaNagrada]...';


GO
ALTER TABLE [dbo].[TimskaNagrada] DROP CONSTRAINT [CK__TimskaNag__TipNa__5165187F];


GO
PRINT N'Starting rebuilding table [dbo].[Grad]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Grad] (
    [GradID] INT          IDENTITY (1, 1) NOT NULL,
    [Drzava] VARCHAR (30) NOT NULL,
    [Ime]    VARCHAR (30) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Grad_PK1] PRIMARY KEY CLUSTERED ([GradID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Grad])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Grad] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Grad] ([GradID], [Drzava], [Ime])
        SELECT   [GradID],
                 [Drzava],
                 [Ime]
        FROM     [dbo].[Grad]
        ORDER BY [GradID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Grad] OFF;
    END

DROP TABLE [dbo].[Grad];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Grad]', N'Grad';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Grad_PK1]', N'Grad_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Igrac]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Igrac] (
    [IgracID]               INT          IDENTITY (1, 1) NOT NULL,
    [Ime]                   VARCHAR (30) NOT NULL,
    [Prezime]               VARCHAR (30) NOT NULL,
    [BrojPostignutihGolova] INT          NOT NULL,
    [Tim_TimId]             INT          NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Igrac_PK1] PRIMARY KEY CLUSTERED ([IgracID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Igrac])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Igrac] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Igrac] ([IgracID], [Ime], [Prezime], [BrojPostignutihGolova], [Tim_TimId])
        SELECT   [IgracID],
                 [Ime],
                 [Prezime],
                 [BrojPostignutihGolova],
                 [Tim_TimId]
        FROM     [dbo].[Igrac]
        ORDER BY [IgracID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Igrac] OFF;
    END

DROP TABLE [dbo].[Igrac];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Igrac]', N'Igrac';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Igrac_PK1]', N'Igrac_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Karta]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Karta] (
    [Odrzava_UtakmicaID] INT NOT NULL,
    [Odrzava_StadionID]  INT NOT NULL,
    [KartaID]            INT IDENTITY (1, 1) NOT NULL,
    [Cena]               INT NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Karta_PK1] PRIMARY KEY CLUSTERED ([KartaID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Karta])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Karta] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Karta] ([KartaID], [Odrzava_UtakmicaID], [Odrzava_StadionID], [Cena])
        SELECT   [KartaID],
                 [Odrzava_UtakmicaID],
                 [Odrzava_StadionID],
                 [Cena]
        FROM     [dbo].[Karta]
        ORDER BY [KartaID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Karta] OFF;
    END

DROP TABLE [dbo].[Karta];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Karta]', N'Karta';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Karta_PK1]', N'Karta_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[LicnaNagrada]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_LicnaNagrada] (
    [NagradaID]     INT          IDENTITY (1, 1) NOT NULL,
    [VrstaNagrade]  VARCHAR (30) NOT NULL,
    [Igrac_IgracID] INT          NULL,
    CONSTRAINT [tmp_ms_xx_constraint_LicnaNagrada_PK1] PRIMARY KEY CLUSTERED ([NagradaID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[LicnaNagrada])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_LicnaNagrada] ON;
        INSERT INTO [dbo].[tmp_ms_xx_LicnaNagrada] ([NagradaID], [VrstaNagrade], [Igrac_IgracID])
        SELECT   [NagradaID],
                 [VrstaNagrade],
                 [Igrac_IgracID]
        FROM     [dbo].[LicnaNagrada]
        ORDER BY [NagradaID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_LicnaNagrada] OFF;
    END

DROP TABLE [dbo].[LicnaNagrada];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_LicnaNagrada]', N'LicnaNagrada';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_LicnaNagrada_PK1]', N'LicnaNagrada_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Nagrada]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Nagrada] (
    [NagradaID] INT IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Nagrada_PK1] PRIMARY KEY CLUSTERED ([NagradaID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Nagrada])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Nagrada] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Nagrada] ([NagradaID])
        SELECT   [NagradaID]
        FROM     [dbo].[Nagrada]
        ORDER BY [NagradaID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Nagrada] OFF;
    END

DROP TABLE [dbo].[Nagrada];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Nagrada]', N'Nagrada';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Nagrada_PK1]', N'Nagrada_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Navijac]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Navijac] (
    [NavijacID]     INT          IDENTITY (1, 1) NOT NULL,
    [Ime]           VARCHAR (30) NOT NULL,
    [Prezime]       INT          NOT NULL,
    [KorisnickoIme] VARCHAR (30) NOT NULL,
    [Email]         VARCHAR (30) NOT NULL,
    [Sifra]         VARCHAR (30) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Navijac_PK1] PRIMARY KEY CLUSTERED ([NavijacID] ASC),
    CONSTRAINT [tmp_ms_xx_constraint_KorisnickoIme1] UNIQUE NONCLUSTERED ([KorisnickoIme] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Navijac])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Navijac] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Navijac] ([NavijacID], [Ime], [Prezime], [KorisnickoIme], [Email], [Sifra])
        SELECT   [NavijacID],
                 [Ime],
                 [Prezime],
                 [KorisnickoIme],
                 [Email],
                 [Sifra]
        FROM     [dbo].[Navijac]
        ORDER BY [NavijacID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Navijac] OFF;
    END

DROP TABLE [dbo].[Navijac];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Navijac]', N'Navijac';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Navijac_PK1]', N'Navijac_PK', N'OBJECT';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_KorisnickoIme1]', N'KorisnickoIme', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Stadion]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Stadion] (
    [StadionID]   INT          IDENTITY (1, 1) NOT NULL,
    [Ime]         VARCHAR (30) NOT NULL,
    [Grad_GradID] INT          NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Stadion_PK1] PRIMARY KEY CLUSTERED ([StadionID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Stadion])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Stadion] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Stadion] ([StadionID], [Ime], [Grad_GradID])
        SELECT   [StadionID],
                 [Ime],
                 [Grad_GradID]
        FROM     [dbo].[Stadion]
        ORDER BY [StadionID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Stadion] OFF;
    END

DROP TABLE [dbo].[Stadion];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Stadion]', N'Stadion';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Stadion_PK1]', N'Stadion_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[sudija]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_sudija] (
    [SudijaID] INT          IDENTITY (1, 1) NOT NULL,
    [Prezime]  VARCHAR (30) NOT NULL,
    [Ime]      VARCHAR (30) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Sudija_PK1] PRIMARY KEY CLUSTERED ([SudijaID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Sudija])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_sudija] ON;
        INSERT INTO [dbo].[tmp_ms_xx_sudija] ([SudijaID], [Prezime], [Ime])
        SELECT   [SudijaID],
                 [Prezime],
                 [Ime]
        FROM     [dbo].[Sudija]
        ORDER BY [SudijaID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_sudija] OFF;
    END

DROP TABLE [dbo].[Sudija];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_sudija]', N'sudija';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Sudija_PK1]', N'Sudija_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Tim]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Tim] (
    [TimID]       INT          IDENTITY (1, 1) NOT NULL,
    [Ime]         VARCHAR (30) NOT NULL,
    [Grad_GradId] INT          NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Tim_PK1] PRIMARY KEY CLUSTERED ([TimID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Tim])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Tim] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Tim] ([TimID], [Ime], [Grad_GradId])
        SELECT   [TimID],
                 [Ime],
                 [Grad_GradId]
        FROM     [dbo].[Tim]
        ORDER BY [TimID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Tim] OFF;
    END

DROP TABLE [dbo].[Tim];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Tim]', N'Tim';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Tim_PK1]', N'Tim_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[TimskaNagrada]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_TimskaNagrada] (
    [NagradaID]  INT          IDENTITY (1, 1) NOT NULL,
    [TipNagrade] VARCHAR (30) NOT NULL,
    [Tim_TimID]  INT          NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Timska_Nagrada_PK1] PRIMARY KEY CLUSTERED ([NagradaID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[TimskaNagrada])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_TimskaNagrada] ON;
        INSERT INTO [dbo].[tmp_ms_xx_TimskaNagrada] ([NagradaID], [TipNagrade], [Tim_TimID])
        SELECT   [NagradaID],
                 [TipNagrade],
                 [Tim_TimID]
        FROM     [dbo].[TimskaNagrada]
        ORDER BY [NagradaID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_TimskaNagrada] OFF;
    END

DROP TABLE [dbo].[TimskaNagrada];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_TimskaNagrada]', N'TimskaNagrada';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Timska_Nagrada_PK1]', N'Timska_Nagrada_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Utakmica]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Utakmica] (
    [UtakmicaID]     INT          IDENTITY (1, 1) NOT NULL,
    [Odigrana]       CHAR (1)     NOT NULL,
    [Datum]          DATE         NOT NULL,
    [FazaTakmicenja] VARCHAR (30) NOT NULL,
    CONSTRAINT [tmp_ms_xx_constraint_Utakmica_PK1] PRIMARY KEY CLUSTERED ([UtakmicaID] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Utakmica])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Utakmica] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Utakmica] ([UtakmicaID], [Odigrana], [Datum], [FazaTakmicenja])
        SELECT   [UtakmicaID],
                 [Odigrana],
                 [Datum],
                 [FazaTakmicenja]
        FROM     [dbo].[Utakmica]
        ORDER BY [UtakmicaID] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Utakmica] OFF;
    END

DROP TABLE [dbo].[Utakmica];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Utakmica]', N'Utakmica';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_Utakmica_PK1]', N'Utakmica_PK', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[Stadion_Grad_FK]...';


GO
ALTER TABLE [dbo].[Stadion] WITH NOCHECK
    ADD CONSTRAINT [Stadion_Grad_FK] FOREIGN KEY ([Grad_GradID]) REFERENCES [dbo].[Grad] ([GradID]);


GO
PRINT N'Creating [dbo].[Tim_Grad_FK]...';


GO
ALTER TABLE [dbo].[Tim] WITH NOCHECK
    ADD CONSTRAINT [Tim_Grad_FK] FOREIGN KEY ([Grad_GradId]) REFERENCES [dbo].[Grad] ([GradID]);


GO
PRINT N'Creating [dbo].[Igrac_Tim_FK]...';


GO
ALTER TABLE [dbo].[Igrac] WITH NOCHECK
    ADD CONSTRAINT [Igrac_Tim_FK] FOREIGN KEY ([Tim_TimId]) REFERENCES [dbo].[Tim] ([TimID]);


GO
PRINT N'Creating [dbo].[LicnaNagrada_Igrac_FK]...';


GO
ALTER TABLE [dbo].[LicnaNagrada] WITH NOCHECK
    ADD CONSTRAINT [LicnaNagrada_Igrac_FK] FOREIGN KEY ([Igrac_IgracID]) REFERENCES [dbo].[Igrac] ([IgracID]);


GO
PRINT N'Creating [dbo].[Karta_Odrzava_FK]...';


GO
ALTER TABLE [dbo].[Karta] WITH NOCHECK
    ADD CONSTRAINT [Karta_Odrzava_FK] FOREIGN KEY ([Odrzava_UtakmicaID], [Odrzava_StadionID]) REFERENCES [dbo].[Odrzava] ([Utakmica_UtakmicaID], [Stadion_StadionID]);


GO
PRINT N'Creating [dbo].[Kupuje_Karta_FK]...';


GO
ALTER TABLE [dbo].[Kupuje] WITH NOCHECK
    ADD CONSTRAINT [Kupuje_Karta_FK] FOREIGN KEY ([Karta_KartaID]) REFERENCES [dbo].[Karta] ([KartaID]);


GO
PRINT N'Creating [dbo].[LicnaNagrada_Nagrada_FK]...';


GO
ALTER TABLE [dbo].[LicnaNagrada] WITH NOCHECK
    ADD CONSTRAINT [LicnaNagrada_Nagrada_FK] FOREIGN KEY ([NagradaID]) REFERENCES [dbo].[Nagrada] ([NagradaID]);


GO
PRINT N'Creating [dbo].[TimskaNagrada_Nagrada_FK]...';


GO
ALTER TABLE [dbo].[TimskaNagrada] WITH NOCHECK
    ADD CONSTRAINT [TimskaNagrada_Nagrada_FK] FOREIGN KEY ([NagradaID]) REFERENCES [dbo].[Nagrada] ([NagradaID]);


GO
PRINT N'Creating [dbo].[Kupuje_Navijac_FK]...';


GO
ALTER TABLE [dbo].[Kupuje] WITH NOCHECK
    ADD CONSTRAINT [Kupuje_Navijac_FK] FOREIGN KEY ([Navijac_NavijacID]) REFERENCES [dbo].[Navijac] ([NavijacID]);


GO
PRINT N'Creating [dbo].[Odrzava_Stadion_FK]...';


GO
ALTER TABLE [dbo].[Odrzava] WITH NOCHECK
    ADD CONSTRAINT [Odrzava_Stadion_FK] FOREIGN KEY ([Stadion_StadionID]) REFERENCES [dbo].[Stadion] ([StadionID]);


GO
PRINT N'Creating [dbo].[Igra_Sudija_FK]...';


GO
ALTER TABLE [dbo].[Igra] WITH NOCHECK
    ADD CONSTRAINT [Igra_Sudija_FK] FOREIGN KEY ([Sudija_SudijaID]) REFERENCES [dbo].[sudija] ([SudijaID]);


GO
PRINT N'Creating [dbo].[Igra_Tim_FK]...';


GO
ALTER TABLE [dbo].[Igra] WITH NOCHECK
    ADD CONSTRAINT [Igra_Tim_FK] FOREIGN KEY ([Tim_TimID]) REFERENCES [dbo].[Tim] ([TimID]);


GO
PRINT N'Creating [dbo].[TimskaNagrada_Tim_FK]...';


GO
ALTER TABLE [dbo].[TimskaNagrada] WITH NOCHECK
    ADD CONSTRAINT [TimskaNagrada_Tim_FK] FOREIGN KEY ([Tim_TimID]) REFERENCES [dbo].[Tim] ([TimID]);


GO
PRINT N'Creating [dbo].[Igra_Utakmica_FK]...';


GO
ALTER TABLE [dbo].[Igra] WITH NOCHECK
    ADD CONSTRAINT [Igra_Utakmica_FK] FOREIGN KEY ([Utakmica_UtakmicaID]) REFERENCES [dbo].[Utakmica] ([UtakmicaID]);


GO
PRINT N'Creating [dbo].[Odrzava_Utakmica_FK]...';


GO
ALTER TABLE [dbo].[Odrzava] WITH NOCHECK
    ADD CONSTRAINT [Odrzava_Utakmica_FK] FOREIGN KEY ([Utakmica_UtakmicaID]) REFERENCES [dbo].[Utakmica] ([UtakmicaID]);


GO
PRINT N'Creating <unnamed>...';


GO
ALTER TABLE [dbo].[LicnaNagrada] WITH NOCHECK
    ADD CHECK (VrstaNagrade IN ('Najbolji Igrac', 'Ferplej', 'Najbolji Strelac'));


GO
PRINT N'Creating <unnamed>...';


GO
ALTER TABLE [dbo].[TimskaNagrada] WITH NOCHECK
    ADD CHECK (TipNagrade IN ('Prvo Mesto', 'Drugo Mesto', 'Trece Mesto'));


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Stadion] WITH CHECK CHECK CONSTRAINT [Stadion_Grad_FK];

ALTER TABLE [dbo].[Tim] WITH CHECK CHECK CONSTRAINT [Tim_Grad_FK];

ALTER TABLE [dbo].[Igrac] WITH CHECK CHECK CONSTRAINT [Igrac_Tim_FK];

ALTER TABLE [dbo].[Karta] WITH CHECK CHECK CONSTRAINT [Karta_Odrzava_FK];

ALTER TABLE [dbo].[Kupuje] WITH CHECK CHECK CONSTRAINT [Kupuje_Karta_FK];

ALTER TABLE [dbo].[Kupuje] WITH CHECK CHECK CONSTRAINT [Kupuje_Navijac_FK];

ALTER TABLE [dbo].[Odrzava] WITH CHECK CHECK CONSTRAINT [Odrzava_Stadion_FK];

ALTER TABLE [dbo].[Igra] WITH CHECK CHECK CONSTRAINT [Igra_Sudija_FK];

ALTER TABLE [dbo].[Igra] WITH CHECK CHECK CONSTRAINT [Igra_Tim_FK];

ALTER TABLE [dbo].[Igra] WITH CHECK CHECK CONSTRAINT [Igra_Utakmica_FK];

ALTER TABLE [dbo].[Odrzava] WITH CHECK CHECK CONSTRAINT [Odrzava_Utakmica_FK];


GO
CREATE TABLE [#__checkStatus] (
    id           INT            IDENTITY (1, 1) PRIMARY KEY CLUSTERED,
    [Schema]     NVARCHAR (256),
    [Table]      NVARCHAR (256),
    [Constraint] NVARCHAR (256)
);

SET NOCOUNT ON;

DECLARE tableconstraintnames CURSOR LOCAL FORWARD_ONLY
    FOR SELECT SCHEMA_NAME([schema_id]),
               OBJECT_NAME([parent_object_id]),
               [name],
               0
        FROM   [sys].[objects]
        WHERE  [parent_object_id] IN (OBJECT_ID(N'dbo.LicnaNagrada'), OBJECT_ID(N'dbo.TimskaNagrada'))
               AND [type] IN (N'F', N'C')
                   AND [object_id] IN (SELECT [object_id]
                                       FROM   [sys].[check_constraints]
                                       WHERE  [is_not_trusted] <> 0
                                              AND [is_disabled] = 0
                                       UNION
                                       SELECT [object_id]
                                       FROM   [sys].[foreign_keys]
                                       WHERE  [is_not_trusted] <> 0
                                              AND [is_disabled] = 0);

DECLARE @schemaname AS NVARCHAR (256);

DECLARE @tablename AS NVARCHAR (256);

DECLARE @checkname AS NVARCHAR (256);

DECLARE @is_not_trusted AS INT;

DECLARE @statement AS NVARCHAR (1024);

BEGIN TRY
    OPEN tableconstraintnames;
    FETCH tableconstraintnames INTO @schemaname, @tablename, @checkname, @is_not_trusted;
    WHILE @@fetch_status = 0
        BEGIN
            PRINT N'Checking constraint: ' + @checkname + N' [' + @schemaname + N'].[' + @tablename + N']';
            SET @statement = N'ALTER TABLE [' + @schemaname + N'].[' + @tablename + N'] WITH ' + CASE @is_not_trusted WHEN 0 THEN N'CHECK' ELSE N'NOCHECK' END + N' CHECK CONSTRAINT [' + @checkname + N']';
            BEGIN TRY
                EXECUTE [sp_executesql] @statement;
            END TRY
            BEGIN CATCH
                INSERT  [#__checkStatus] ([Schema], [Table], [Constraint])
                VALUES                  (@schemaname, @tablename, @checkname);
            END CATCH
            FETCH tableconstraintnames INTO @schemaname, @tablename, @checkname, @is_not_trusted;
        END
END TRY
BEGIN CATCH
    PRINT ERROR_MESSAGE();
END CATCH

IF CURSOR_STATUS(N'LOCAL', N'tableconstraintnames') >= 0
    CLOSE tableconstraintnames;

IF CURSOR_STATUS(N'LOCAL', N'tableconstraintnames') = -1
    DEALLOCATE tableconstraintnames;

SELECT N'Constraint verification failed:' + [Schema] + N'.' + [Table] + N',' + [Constraint]
FROM   [#__checkStatus];

IF @@ROWCOUNT > 0
    BEGIN
        DROP TABLE [#__checkStatus];
        RAISERROR (N'An error occurred while verifying constraints', 16, 127);
    END

SET NOCOUNT OFF;

DROP TABLE [#__checkStatus];


GO
PRINT N'Update complete.';


GO
